<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src/main.ts</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">All files</a> / <a href="index.html">src</a> main.ts
    </h1>
    <div class='clearfix'>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135</td><td class="line-coverage quiet"><span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js"><span class="cstat-no" title="statement not covered" >import * as compression from 'compression';</span>
<span class="cstat-no" title="statement not covered" >import * as express from 'express';</span>
<span class="cstat-no" title="statement not covered" >import * as path from 'path';</span>
<span class="cstat-no" title="statement not covered" >import * as s3Proxy from 's3-proxy';</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >import {LoggerService, NotFoundException} from '@nestjs/common';</span>
<span class="cstat-no" title="statement not covered" >import { NestFactory } from '@nestjs/core';</span>
<span class="cstat-no" title="statement not covered" >import { DocumentBuilder, SwaggerModule } from '@nestjs/swagger';</span>
<span class="cstat-no" title="statement not covered" >import { ConfigService } from '@sierralabs/nest-utils';</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >import { AppModule } from './app.module';</span>
<span class="cstat-no" title="statement not covered" >import { ErrorFilter } from './common/error/error.filter';</span>
<span class="cstat-no" title="statement not covered" >import { TaskRunner, TaskType } from './task-runner';</span>
<span class="cstat-no" title="statement not covered" >import { GreenDirectLogger } from './greendirect-logger';</span>
&nbsp;
/**
 * Start the Green Direct API Nest JS App
 */
async function <span class="fstat-no" title="function not covered" >bootstrap() {</span>
  const packageInfo = <span class="cstat-no" title="statement not covered" >require(process.cwd() + '/package.json');</span>
  const logger: LoggerService = <span class="cstat-no" title="statement not covered" >new GreenDirectLogger('Main');</span>
  let nestFactoryOptions;
&nbsp;
  const environment = <span class="cstat-no" title="statement not covered" >process.env.NODE_ENV || 'development';</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  if (environment !== 'development') {</span>
    // used in AWS environment since cloudwatch doesn't format fancy logging properly
<span class="cstat-no" title="statement not covered" >    nestFactoryOptions = {</span>
      // logger: this.logger,
    };
  }
<span class="cstat-no" title="statement not covered" >  logger.log(`Environment  : ${environment}`);</span>
<span class="cstat-no" title="statement not covered" >  logger.log(`Version      : ${packageInfo.version}`);</span>
&nbsp;
  const expressServer = <span class="cstat-no" title="statement not covered" >express();</span>
<span class="cstat-no" title="statement not covered" >  expressServer.use(compression());</span>
  const app = <span class="cstat-no" title="statement not covered" >await NestFactory.create(</span>
    AppModule,
    expressServer,
    nestFactoryOptions,
  );
<span class="cstat-no" title="statement not covered" >  app.enableCors({ origin: '*' });</span>
  const configService = <span class="cstat-no" title="statement not covered" >new ConfigService();</span>
  const port = <span class="cstat-no" title="statement not covered" >configService.get('http.port') || 3000;</span>
  const isExplorer = <span class="cstat-no" title="statement not covered" >configService.get('api.explorer');</span>
  const explorerPath = <span class="cstat-no" title="statement not covered" >configService.get('api.explorerPath') || 'api';</span>
  const basePath = <span class="cstat-no" title="statement not covered" >configService.get('api.basePath') || '';</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  app.setGlobalPrefix(basePath);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  app.useGlobalFilters(new ErrorFilter());</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  if (isExplorer) {</span>
    const options = <span class="cstat-no" title="statement not covered" >new DocumentBuilder()</span>
      .setBasePath(basePath)
      .setTitle('Project')
      .setDescription('API Documentation')
      .setVersion('1.0')
      .addBearerAuth()
      // .addTag('tag')
      .build();
    const document = <span class="cstat-no" title="statement not covered" >SwaggerModule.createDocument(app, options);</span>
<span class="cstat-no" title="statement not covered" >    SwaggerModule.setup(explorerPath, app, document);</span>
  }
&nbsp;
  /*
   * Apply middleware to asset calls, especially to
   * implement HTTP Proxy for greendirect-web hosted on S3
   * For staging / production only: development is allowed but loads staging WEB instance
   */
<span class="cstat-no" title="statement not covered" >  if (environment !== 'test') {</span>
<span class="cstat-no" title="statement not covered" >    expressServer.get('*', <span class="fstat-no" title="function not covered" >(r</span>equest, response, next) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >      if (request.path.startsWith('/api')) {</span>
<span class="cstat-no" title="statement not covered" >        return next();</span>
      }
&nbsp;
      /* 1. Subroutes (except for root) with slash are redirected to non-slash to proceed to step 2. */
<span class="cstat-no" title="statement not covered" >      if (request.path.endsWith('/') &amp;&amp; request.path.length &gt; 1) {</span>
        const removeTrailingSlash = <span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" >url =&gt;</span> {</span>
          const [_path, query] = <span class="cstat-no" title="statement not covered" >url.split('?');</span>
<span class="cstat-no" title="statement not covered" >          return _path.slice(0, -1) + (!!query ? `?${query}` : '');</span>
        };
<span class="cstat-no" title="statement not covered" >        response.redirect(301, removeTrailingSlash(request.originalUrl));</span>
<span class="cstat-no" title="statement not covered" >        return;</span>
      }
&nbsp;
      const hasFileExtension = <span class="cstat-no" title="statement not covered" >path.extname(request.originalUrl);</span>
      const hasQueryString = <span class="cstat-no" title="statement not covered" >request.originalUrl.includes('?');</span>
      const options = <span class="cstat-no" title="statement not covered" >{</span>
        bucket: configService.get('client.aws.bucket'),
        accessKeyId: configService.get('client.aws.accessKeyId'),
        secretAccessKey: configService.get('client.aws.secretAccessKey'),
        defaultKey: 'index.html',
      };
&nbsp;
      /* 2. Routes with slashes already removed, (except for root, to be handled in step 3.)
        If a URL has querystring then assume it should be handled via angular and not an asset
        extension for example would extract a period regardless of file name or part of querystring */
<span class="cstat-no" title="statement not covered" >      if (!hasFileExtension || hasQueryString) {</span>
        /* Main landing pages follow S3 defaultKey: index.html (browser unaware) */
<span class="cstat-no" title="statement not covered" >        if (request.path.startsWith('/admin')) {</span>
<span class="cstat-no" title="statement not covered" >          request.originalUrl = '/admin/index.html';</span>
        } else <span class="cstat-no" title="statement not covered" >if (request.path.startsWith('/es')) {</span>
<span class="cstat-no" title="statement not covered" >          request.originalUrl = '/es/index.html';</span>
        } else {
          /* 3. Root default landing page, etc, default to English portal */
<span class="cstat-no" title="statement not covered" >          request.originalUrl = '/index.html';</span>
          /* 4. For sub-routes, (from 1.), don't expect an index.html. They are not landing pages. */
<span class="cstat-no" title="statement not covered" >          if (request.path !== '/') {</span>
<span class="cstat-no" title="statement not covered" >            delete options.defaultKey;</span>
          }
        }
      }
&nbsp;
      const referer = <span class="cstat-no" title="statement not covered" >request.header('Referer');</span>
      // logger.log(`${referer} ${request.method} ${request.originalUrl}`);
<span class="cstat-no" title="statement not covered" >      s3Proxy(options)(request, response, <span class="fstat-no" title="function not covered" >error =&gt;</span> {</span>
<span class="cstat-no" title="statement not covered" >        if (error &amp;&amp; error.status === 404) {</span>
<span class="cstat-no" title="statement not covered" >          response.type('json');</span>
<span class="cstat-no" title="statement not covered" >          return next(new NotFoundException());</span>
        }
<span class="cstat-no" title="statement not covered" >        next(error);</span>
      });
    });
  }
<span class="cstat-no" title="statement not covered" >  await app.listen(port);</span>
}
&nbsp;
<span class="cstat-no" title="statement not covered" >if (process.env.TASK) {</span>
  const taskRunner = <span class="cstat-no" title="statement not covered" >new TaskRunner(process.env.TASK as TaskType);</span>
<span class="cstat-no" title="statement not covered" >  taskRunner.run();</span>
} else {
<span class="cstat-no" title="statement not covered" >  bootstrap();</span>
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="https://istanbul.js.org/" target="_blank">istanbul</a> at Sun Sep 05 2021 12:51:52 GMT+0000 (Coordinated Universal Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
