import { TestingModule } from '@nestjs/testing';
import { endOfYear, startOfYear } from 'date-fns';
import { CouponService } from '../../src/coupon/coupon.service';
import {
  Coupon,
  DiscountApplication,
  DiscountType,
} from '../../src/entities/coupon.entity';
import { Repository, getRepository } from 'typeorm';
import { Location } from '../../src/entities/location.entity';
import { CouponDay } from '../../src/entities/coupon-day.entity';
import { LocationCoupon } from '../../src/entities/location-coupon.entity';
import * as Fixtures from '../fixtures';

export const LOCATIONS_WITH_COUPONS = [
  'NextGen Dispensary',
  'BWell Ocean',
  'ISBX',
];

export const MOCK_COUPON_DATA: Partial<Coupon>[] = [
  {
    name: '5$ Discount for everything!',
    description: 'Cardigan hexagon artisan venmo fingerstache',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Fixed,
    discountAmount: 5.0,
    discountApplication: DiscountApplication.Subtotal,
    applyWithOther: true,
    couponSku: '1234',
    isForDelivery: true,
  },
  {
    name: '20% off for everything!',
    description: 'Cardigan hexagon artisan venmo fingerstache',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Percent,
    discountAmount: 20.0,
    discountApplication: DiscountApplication.Subtotal,
    applyWithOther: true,
    couponSku: '2341',
    isForDelivery: true,
  },
  {
    name: '10% off all online purchases',
    description: '',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: null,
    expirationDate: null,
    couponDays: [],
    discountType: DiscountType.Percent,
    discountAmount: 10.0,
    discountApplication: DiscountApplication.Subtotal,
    applyWithOther: true,
    couponSku: 'EXPRESS10',
    isForPickup: true,
    isForDelivery: true,
  },
  {
    name: '10% off applicable with other coupons',
    description: 'Cardigan hexagon artisan venmo fingerstache',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Percent,
    discountAmount: 10.0,
    discountApplication: DiscountApplication.Subtotal,
    applyWithOther: true,
    couponSku: '3412',
    isForDelivery: true,
  },
  {
    name: '50% discount for items minimum of 10, during fridays, 8 AM - 8 PM',
    description: 'Cardigan hexagon artisan venmo fingerstache',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Percent,
    discountAmount: 50.0,
    discountApplication: DiscountApplication.Subtotal,
    applyWithOther: true,
    couponSku: '4123',
    isForDelivery: true,
  },
  {
    name: '10$ Discount on Product Category',
    description: 'Cardigan hexagon artisan venmo fingerstache',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Fixed,
    discountAmount: 10.0,
    discountApplication: DiscountApplication.Subtotal,
    applyWithOther: true,
    couponSku: '41231',
    isForDelivery: true,
  },
  {
    name: '10% discount for manual coupon 01',
    description: '(not visible)',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Percent,
    discountAmount: 10.0,
    discountApplication: DiscountApplication.Subtotal,
    couponSku: 'MANUAL01',
    isVisible: false,
    isAutoApply: false,
    applyWithOther: true,
    isForDelivery: true,
    isForPickup: true,
  },
  {
    name: '10% discount for manual coupon 02',
    description: 'One time used only (not visible)',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Percent,
    discountAmount: 10.0,
    discountApplication: DiscountApplication.Subtotal,
    couponSku: 'MANUAL02',
    isVisible: false,
    isOneTimeUse: true,
    isAutoApply: false,
    applyWithOther: true,
    isForDelivery: true,
    isForPickup: true,
  },
  {
    name: '10% discount for manual coupon 03',
    description: 'For delivery only (not visible)',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Percent,
    discountAmount: 10.0,
    discountApplication: DiscountApplication.Subtotal,
    couponSku: 'MANUAL03',
    isVisible: false,
    isOneTimeUse: false,
    isAutoApply: false,
    applyWithOther: true,
    isForDelivery: true,
    isForPickup: false,
  },
  {
    name: '10% discount for manual coupon 04',
    description: 'For pickup only (not visible)',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Percent,
    discountAmount: 10.0,
    discountApplication: DiscountApplication.Subtotal,
    couponSku: 'MANUAL04',
    isVisible: false,
    isOneTimeUse: false,
    isAutoApply: false,
    applyWithOther: true,
    isForDelivery: false,
    isForPickup: true,
  },
  {
    name: '10% discount for manual coupon 05',
    description: 'Cannot be used together with other coupon (not visible)',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Percent,
    discountAmount: 10.0,
    discountApplication: DiscountApplication.Subtotal,
    couponSku: 'MANUAL05',
    isVisible: false,
    isOneTimeUse: false,
    isAutoApply: false,
    applyWithOther: false,
    isForDelivery: true,
    isForPickup: true,
  },
  {
    name: '10% discount for manual coupon 06',
    description: 'Cardigan hexagon artisan venmo fingerstache',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Percent,
    discountAmount: 10.0,
    discountApplication: DiscountApplication.Subtotal,
    applyWithOther: true,
    couponSku: 'MANUAL06',
    isForPickup: true,
    isForDelivery: true,
  },
  {
    name: '10% discount for manual coupon 07',
    description: 'Cardigan hexagon artisan venmo fingerstache',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Percent,
    discountAmount: 10.0,
    discountApplication: DiscountApplication.Subtotal,
    applyWithOther: true,
    couponSku: 'MANUAL07',
    isForPickup: true,
    isForDelivery: true,
  },
  {
    name: '10% discount for manual coupon 08',
    description: '(not visible)',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Percent,
    discountAmount: 10.0,
    discountApplication: DiscountApplication.Subtotal,
    couponSku: 'MANUAL08',
    isVisible: false,
    isAutoApply: false,
    applyWithOther: true,
    isForDelivery: true,
    isForPickup: true,
  },
  {
    name: '10% discount for manual coupon 09',
    description: '(not visible)',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Percent,
    discountAmount: 10.0,
    discountApplication: DiscountApplication.Subtotal,
    couponSku: 'MANUAL09',
    isVisible: false,
    isAutoApply: false,
    applyWithOther: true,
    isForDelivery: true,
    isForPickup: true,
  },
];

export const MOCK_COUPON_DYNAMIC_DATA: Partial<Coupon>[] = [
  {
    name: '5$ Discount for everything!',
    description: 'Cardigan hexagon artisan venmo fingerstache',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Fixed,
    discountAmount: 5.0,
    discountApplication: DiscountApplication.Subtotal,
    applyWithOther: true,
    couponSku: '1234' + new Date().getTime(),
    isForDelivery: true,
  },
  {
    name: '20% off for everything!',
    description: 'Cardigan hexagon artisan venmo fingerstache',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Percent,
    discountAmount: 20.0,
    discountApplication: DiscountApplication.Subtotal,
    applyWithOther: true,
    couponSku: '1234' + new Date().getTime(),
    isForDelivery: true,
  },
  {
    name: '10% off all online purchases',
    description: '',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: null,
    expirationDate: null,
    couponDays: [],
    discountType: DiscountType.Percent,
    discountAmount: 10.0,
    discountApplication: DiscountApplication.Subtotal,
    applyWithOther: true,
    couponSku: 'EXPRESS10' + new Date().getTime(),
    isForPickup: true,
    isForDelivery: true,
  },
  {
    name: '10% off applicable with other coupons',
    description: 'Cardigan hexagon artisan venmo fingerstache',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Percent,
    discountAmount: 10.0,
    discountApplication: DiscountApplication.Subtotal,
    applyWithOther: true,
    couponSku: '3412'+ new Date().getTime(),
    isForDelivery: true,
  },
  {
    name: '50% discount for items minimum of 10, during fridays, 8 AM - 8 PM',
    description: 'Cardigan hexagon artisan venmo fingerstache',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Percent,
    discountAmount: 50.0,
    discountApplication: DiscountApplication.Subtotal,
    applyWithOther: true,
    couponSku: '4123'+ new Date().getTime(),
    isForDelivery: true,
  },
  {
    name: '10$ Discount on Product Category',
    description: 'Cardigan hexagon artisan venmo fingerstache',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Fixed,
    discountAmount: 10.0,
    discountApplication: DiscountApplication.Subtotal,
    applyWithOther: true,
    couponSku: '41231'+ new Date().getTime(),
    isForDelivery: true,
  },
  {
    name: '10% discount for manual coupon 01',
    description: '(not visible)',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Percent,
    discountAmount: 10.0,
    discountApplication: DiscountApplication.Subtotal,
    couponSku: 'MANUAL01'+ new Date().getTime(),
    isVisible: false,
    isAutoApply: false,
    applyWithOther: true,
    isForDelivery: true,
    isForPickup: true,
  },
  {
    name: '10% discount for manual coupon 02',
    description: 'One time used only (not visible)',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Percent,
    discountAmount: 10.0,
    discountApplication: DiscountApplication.Subtotal,
    couponSku: 'MANUAL02'+ new Date().getTime(),
    isVisible: false,
    isOneTimeUse: true,
    isAutoApply: false,
    applyWithOther: true,
    isForDelivery: true,
    isForPickup: true,
  },
  {
    name: '10% discount for manual coupon 03',
    description: 'For delivery only (not visible)',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Percent,
    discountAmount: 10.0,
    discountApplication: DiscountApplication.Subtotal,
    couponSku: 'MANUAL03'+ new Date().getTime(),
    isVisible: false,
    isOneTimeUse: false,
    isAutoApply: false,
    applyWithOther: true,
    isForDelivery: true,
    isForPickup: false,
  },
  {
    name: '10% discount for manual coupon 04',
    description: 'For pickup only (not visible)',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Percent,
    discountAmount: 10.0,
    discountApplication: DiscountApplication.Subtotal,
    couponSku: 'MANUAL04'+ new Date().getTime(),
    isVisible: false,
    isOneTimeUse: false,
    isAutoApply: false,
    applyWithOther: true,
    isForDelivery: false,
    isForPickup: true,
  },
  {
    name: '10% discount for manual coupon 05',
    description: 'Cannot be used together with other coupon (not visible)',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Percent,
    discountAmount: 10.0,
    discountApplication: DiscountApplication.Subtotal,
    couponSku: 'MANUAL05'+ new Date().getTime(),
    isVisible: false,
    isOneTimeUse: false,
    isAutoApply: false,
    applyWithOther: false,
    isForDelivery: true,
    isForPickup: true,
  },
  {
    name: '10% discount for manual coupon 06',
    description: 'Cardigan hexagon artisan venmo fingerstache',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Percent,
    discountAmount: 10.0,
    discountApplication: DiscountApplication.Subtotal,
    applyWithOther: true,
    couponSku: 'MANUAL06'+ new Date().getTime(),
    isForPickup: true,
    isForDelivery: true,
  },
  {
    name: '10% discount for manual coupon 07',
    description: 'Cardigan hexagon artisan venmo fingerstache',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Percent,
    discountAmount: 10.0,
    discountApplication: DiscountApplication.Subtotal,
    applyWithOther: true,
    couponSku: 'MANUAL07'+ new Date().getTime(),
    isForPickup: true,
    isForDelivery: true,
  },
  {
    name: '10% discount for manual coupon 08',
    description: '(not visible)',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Percent,
    discountAmount: 10.0,
    discountApplication: DiscountApplication.Subtotal,
    couponSku: 'MANUAL08'+ new Date().getTime(),
    isVisible: false,
    isAutoApply: false,
    applyWithOther: true,
    isForDelivery: true,
    isForPickup: true,
  },
  {
    name: '10% discount for manual coupon 09',
    description: '(not visible)',
    imageUrl: 'https://placekitten.com/300/300',
    effectiveDate: startOfYear(new Date()),
    expirationDate: endOfYear(new Date()),
    couponDays: [],
    discountType: DiscountType.Percent,
    discountAmount: 10.0,
    discountApplication: DiscountApplication.Subtotal,
    couponSku: 'MANUAL09'+ new Date().getTime(),
    isVisible: false,
    isAutoApply: false,
    applyWithOther: true,
    isForDelivery: true,
    isForPickup: true,
  },
];

export class CouponMock {
  private couponService: CouponService;
  private locationRepository: Repository<Location>;

  constructor(private readonly module: TestingModule) {
    this.couponService = this.module.get<CouponService>(CouponService);
    this.locationRepository = getRepository<Location>(Location);
  }

  async generate() {
    await this.setupCoupons();
  }
  async randomGenerate(userId: number, location: Location) {
    const couponDay = [
      {
        dayOfWeek: new Date().getDay(),
        startTime: '00:00:01',
        endTime: '23:59:59',
      },
    ] as CouponDay[];
    const limitCategories = [{ createdBy: userId, category: 'Some Category' + new Date().getTime }];
    const couponLimit = {
      categories: limitCategories,
    };
    const ts = +new Date(); // force milliseconds
    const couponSKU = `test${+new Date()}`;
    const couponLocations = [
      {
        location: location,
      },
    ] as LocationCoupon[];
    let coupon = new Fixtures.CouponFixture() as Coupon;
    coupon = {
      ...coupon,
      couponLocations: couponLocations,
      isAutoApply: false,
      couponDays: couponDay,
      createdBy: userId,
      discountType: DiscountType.Fixed,
      discountApplication: DiscountApplication.SingleLineItem,
      couponSku: couponSKU,
    }
    const result = await this.couponService.createCoupon(coupon);
    return result;    
  }

  async setupCoupons() {
    const pattern = `^(?:.*(?:${LOCATIONS_WITH_COUPONS.join('|')}).*)$`;
    const locations = await this.locationRepository
      .createQueryBuilder('location')
      .select()
      .where('location.name ~ :pattern', { pattern })
      .getMany();
          
    return Promise.all(
      MOCK_COUPON_DATA.map(async coupon => {
        coupon.couponLocations = locations.map((location: Location) => ({
          location: location.id,
        })) as any[];
        return this.couponService.createCoupon(coupon as any);
      }),
    );
  }
}
